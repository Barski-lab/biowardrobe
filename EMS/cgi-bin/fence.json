#! /usr/bin/env python

import os
import sys
import MySQLdb
#import warnings
import cgitb; cgitb.enable()
import cgi
import urllib
import urlparse
import simplejson as json
import Arguments


def error_msg(msg):
 print """
   {"success": false, "message": "%s" }"""%(msg)
 sys.exit()

arguments = Arguments.Arguments(sys.argv)


#stdinbuf = sys.stdin.read()
#if stdinbuf is None:
# error_msg("No data")

form = cgi.FieldStorage()
recordid=int(form["recordid"].value)

try:
 conn = MySQLdb.connect (host = arguments.readString("SQLE/HOST"),user = arguments.readString("SQLE/USER"), passwd=arguments.readPass("SQLE/PASS"), db=arguments.readString("SQLE/DB"))
 cursor = conn.cursor ()
except Exception, e: 
 error_msg("Error database connection")


cursor.execute ("select filename,w.worker,e.etype from labdata l,experimenttype e,worker w "
" where e.id=experimenttype_id and w.id=worker_id and l.id=%s",recordid)
SUBDIR='/DNA/'
NAME=''
FNAME=''
row = cursor.fetchone()

if not row:
    error_msg('Record id does not exists '+str(recordid))

FNAME=row[0]
if ";" in FNAME:
    FNAME=row[0].split(";")[0]
    
if 'RNA' in row[2]:
    SUBDIR='/RNA/'
NAME=row[1].upper()

FULLNAME='/data/DATA/FASTQ-DATA/'+NAME+SUBDIR+FNAME+'.fence'

#FP_N=open(sys.argv[1],'r')
try:
    FP_N=open(FULLNAME,'r')
except e:
    error_msg('Cant open file '+str(e))

POSS=FP_N.readline()

CAS=FP_N.readline()
CCS=FP_N.readline()
CTS=FP_N.readline()
CGS=FP_N.readline()
CNS=FP_N.readline()
FP_N.close()

CA=list()
CC=list()
CT=list()
CG=list()
CN=list()

POS=POSS.split()
idxo=0
idx=0

for i in range(0,len(POS)):
    idx=POSS.find(POS[i])
    idxe=idx+len(POS[i])
    if i==0:
	idxo=idxe
	continue
    
    if(CAS[idxo:idxe].strip()==''):
	CA.append(0)
    else:
	CA.append(int(CAS[idxo:idxe]))

    if(CCS[idxo:idxe].strip()==''):
	CC.append(0)
    else:
	CC.append(int(CCS[idxo:idxe]))
    
    if(CTS[idxo:idxe].strip()==''):
	CT.append(0)
    else:
	CT.append(int(CTS[idxo:idxe]))
    
    if(CGS[idxo:idxe].strip()==''):
	CG.append(0)
    else:
	CG.append(int(CGS[idxo:idxe]))
    
    if(CNS[idxo:idxe].strip()==''):
	CN.append(0)
    else:
	CN.append(int(CNS[idxo:idxe]))
    idxo=idxe
    
comma=""


print """
{"success":true, "data":[""",

for i in range(1,len(CA)):

 print """%s{"""%(comma),
 print """ "id":"%d", """%(i),
 print """ "A":"%s", """%(CA[i]),
 print """ "C":"%s", """%(CC[i]),
 print """ "T":"%s", """%(CT[i]),
 print """ "G":"%s", """%(CG[i]),
 print """ "N":"%s" """%(CN[i]),
 print """}""",
 comma=","

print """]}"""


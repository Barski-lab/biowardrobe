#! /usr/bin/env python

import os
import sys
import MySQLdb
#import warnings
import cgitb; cgitb.enable()
import cgi
import urllib
import urlparse
import simplejson as json
import Arguments


def error_msg(msg):
 print """
   {"success": false, "message": "%s" }"""%(msg)
 sys.exit()

arguments = Arguments.Arguments(sys.argv)


#stdinbuf = sys.stdin.read()
#if stdinbuf is None:
# error_msg("No data")

form = cgi.FieldStorage()
recordid=int(form["recordid"].value)

try:
 conn = MySQLdb.connect (host = arguments.readString("SQLE/HOST"),user = arguments.readString("SQLE/USER"), passwd=arguments.readPass("SQLE/PASS"), db=arguments.readString("SQLE/DB"))
 cursor = conn.cursor ()
except Exception, e: 
 error_msg("Error database connection")


cursor.execute ("select filename,w.worker,e.etype from labdata l,experimenttype e,worker w "
" where e.id=experimenttype_id and w.id=worker_id and l.id=%s",recordid)
SUBDIR='/DNA/'
NAME=''
FNAME=''
row = cursor.fetchone()

if not row:
    error_msg('Record id does not exists '+str(recordid))

FNAME=row[0]
if ";" in FNAME:
    FNAME=row[0].split(";")[0]
    
if 'RNA' in row[2]:
    SUBDIR='/RNA/'
NAME=row[1].upper()

FULLNAME='/data/DATA/FASTQ-DATA/'+NAME+SUBDIR+FNAME+'.fence'

#FP_N=open(sys.argv[1],'r')
try:
    FP_N=open(FULLNAME,'r')
except e:
    error_msg('Cant open file '+str(e))

FP_N.readline()

CA=FP_N.readline().split()
CC=FP_N.readline().split()
CT=FP_N.readline().split()
CG=FP_N.readline().split()
FP_N.close()

comma=""


print """
{"success":true, "data":[""",

for i in range(1,len(CA)):

 print """%s{"""%(comma),
 print """ "id":"%d", """%(i),
 print """ "A":"%s", """%(CA[i]),
 print """ "C":"%s", """%(CC[i]),
 print """ "T":"%s", """%(CT[i]),
 print """ "G":"%s" """%(CG[i]),
 print """}""",
 comma=","

print """]}"""


#! /usr/bin/env python

import os
import sys
import MySQLdb
#import warnings
import cgitb; cgitb.enable()
import cgi
import urllib
import urlparse
import simplejson
import Arguments


def error_msg(msg):
 print """
   {"success": false, "message": "%s" }"""%(msg)
 sys.exit()

arguments = Arguments.Arguments(sys.argv)


stdinbuf = sys.stdin.read()
if stdinbuf is None:
 error_msg("No data")

url_parse = dict(urlparse.parse_qs(stdinbuf))
if url_parse['tablename'][0] is None:
 error_msg("Empty table name")
if url_parse['data'][0] is None:
 error_msg("No data")

table_name=url_parse['tablename'][0]
jsondata = simplejson.loads(url_parse['data'][0])

if jsondata is None:
 error_msg("No data")

try:
 conn = MySQLdb.connect (host = arguments.readString("SQL/HOST"),user = arguments.readString("SQL/USER"), passwd=arguments.readPass("SQL/PASS"), db=arguments.readString("SQL/DB"))
 cursor = conn.cursor ()
except Exception, e: 
 error_msg("Error database connection")


try:
 SQL=str()
 is_str=0
 SET_V=str()
 ID=str()
 
 for rows in jsondata:

  #if just one new record
  if type(rows) is str:
   if rows == 'id':
    ID=str(jsondata[rows]).replace("'","").replace('"','').replace(';','')
    continue

   SET_V+=str(rows).replace("'","").replace('"','').replace(';','')+"="
   SET_V+="'"+str(jsondata[rows]).replace("'","").replace('"','').replace(';','')+"',"
   is_str=is_str+1
   continue
  else:
  #if many records
   ID=str()
   for i in rows:
    #in inserts ID should be 0
    if str(i) == 'id':
     ID=str(rows[i])
     continue

    SET_V+=str(i).replace("'","").replace('"','').replace(';','')+"="
    SET_V+="'"+str(rows[i]).replace("'","").replace('"','').replace(';','')+"',"

   #remove last ,
  SET_V=SET_V[:-1]
  if (not ID):
   error_msg("No ID")
  STR="""UPDATE `%s` SET %s WHERE id=%s;"""%(table_name,SET_V,ID)
  SQL+=STR
  SET_V=str()
  ID=str()

 if is_str > 0:
  #remove last ,
  if (not ID):
   error_msg("No ID")
  SET_V=SET_V[:-1]
  STR="""UPDATE `%s` SET %s WHERE id=%s;"""%(table_name,SET_V,ID)
  SQL+=STR


 cursor.execute(SQL)
 cursor.close()
 conn.commit()
 conn.close()

 print """
  {"success": true, "message": "Data saved" }"""

except Exception, e:
 cursor.close()
 conn.rollback()
 conn.close()
 Error_str=str(e).replace('"','')

 if 'Duplicate' in Error_str:
  error_msg(Error_str)

 error_msg("Error updating: " +Error_str+"<br>'"+SQL+"' ")


